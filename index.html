<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flood Monitoring Dashboard</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 95%;
        margin: auto;
        padding-top: 20px;
    }

    .box {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px #ccc;
    }

    .row {
        display: flex;
        gap: 20px;
        width: 100%;
    }

    .col {
        flex: 1;
    }

    h2 {
        margin-top: 0;
        color: #007bff;
    }

    .value {
        font-size: 40px;
        font-weight: bold;
        margin-top: 10px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

    <!-- CURRENT WATER LEVEL -->
    <div class="box">
        <h2>Current Water Level</h2>
        <div id="waterLevel" class="value">--%</div>
        <div>Rain: <span id="rainValue">--%</span></div>
        <div>Time: <span id="recordTime">--</span></div>
    </div>

    <!-- FORECAST -->
    <div class="box">
        <h2>1-Minute Forecast</h2>
        <div>Predicted Water Level: <span id="predictedHeight" class="value">--%</span></div>
        <div>Rain Condition: <span id="predictedRain">--</span></div>
        <div>Flood Risk: <span id="predictedRisk">--</span></div>
    </div>

    <!-- WATER LEVEL CHART -->
    <div class="box">
        <h2>Water Level Trend</h2>
        <canvas id="waterChart"></canvas>
    </div>

    <!-- RAIN CHART -->
    <div class="box">
        <h2>Rain Intensity</h2>
        <canvas id="rainChart"></canvas>
    </div>

</div>


<audio id="alarmSound">
    <source src="alarm.mp3" type="audio/mpeg">
</audio>

<!-- ================================================================
     JAVASCRIPT STARTS HERE (FORECAST FIXED TO 1 MINUTE)
================================================================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getDatabase, ref, query, limitToLast, onValue }
from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

/* -------------------------------------------------------------
   ðŸ”¥ UPDATE THIS WITH YOUR FIREBASE CONFIG
------------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "xxxx.firebaseapp.com",
    databaseURL: "https://xxxx-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "xxxx",
    storageBucket: "xxxx.appspot.com",
    messagingSenderId: "xxxx",
    appId: "xxxx"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* HTML ELEMENTS */
const waterLevelEl = document.getElementById("waterLevel");
const rainValueEl = document.getElementById("rainValue");
const timeEl = document.getElementById("recordTime");

const predHeightEl = document.getElementById("predictedHeight");
const predRainEl = document.getElementById("predictedRain");
const predRiskEl = document.getElementById("predictedRisk");
const alarm = document.getElementById("alarmSound");

/* -------------------------------------------------------------
   CHART INITIALIZATION
------------------------------------------------------------- */
let waterChart = new Chart(document.getElementById("waterChart"), {
    type: "line",
    data: {
        labels: [],
        datasets: [
            {
                label: "Water Level (%)",
                data: [],
                borderColor: "#007bff",
                borderWidth: 2
            },
            {
                label: "1-Min Forecast",
                data: [],
                borderColor: "red",
                borderDash: [5,5],
                borderWidth: 2
            }
        ]
    },
    options: { responsive: true }
});

let rainChart = new Chart(document.getElementById("rainChart"), {
    type: "bar",
    data: {
        labels: [],
        datasets: [
            {
                label: "Rain %",
                data: [],
                backgroundColor: "#00a65a"
            }
        ]
    },
    options: { responsive: true }
});

/* -------------------------------------------------------------
   PREDICTION LOGIC (1 MINUTE AHEAD)
------------------------------------------------------------- */
function computePrediction1Min(records) {

    if (records.length < 2) return null;

    const last = records[records.length - 1];
    const prev = records[records.length - 2];

    // Slope per minute
    const slope = last.water - prev.water;

    // Predict 1 minute ahead
    const predicted = last.water + slope;

    // Rain label
    let rainLabel = "No Rain";
    if (last.rain > 70) rainLabel = "Heavy";
    else if (last.rain > 40) rainLabel = "Moderate";
    else if (last.rain > 10) rainLabel = "Light";

    // Flood risk
    let risk = "Low";
    if (predicted > 80) risk = "High";
    else if (predicted > 50) risk = "Medium";

    return {
        predictedValue: predicted,
        predictedRainLabel: rainLabel,
        risk: risk
    };
}

/* -------------------------------------------------------------
   UPDATE FORECAST ON SCREEN
------------------------------------------------------------- */
function updateForecast(records) {
    const pred = computePrediction1Min(records);

    if (!pred) return;

    predHeightEl.innerText = pred.predictedValue.toFixed(1) + "%";
    predRainEl.innerText = pred.predictedRainLabel;
    predRiskEl.innerText = pred.risk;

    // Update forecast graph line
    waterChart.data.datasets[1].data =
        new Array(records.length - 1).fill(null);
    waterChart.data.datasets[1].data.push(pred.predictedValue);
    waterChart.update();
}

/* -------------------------------------------------------------
   REALTIME DATA LISTENER
------------------------------------------------------------- */

let latestRecords = [];

onValue(query(ref(db, "flood-data/records"), limitToLast(20)), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const records = Object.values(data);
    latestRecords = records;

    const labels = records.map(r => r.time);
    const water = records.map(r => r.water);
    const rain = records.map(r => r.rain);

    // Update charts
    waterChart.data.labels = labels;
    waterChart.data.datasets[0].data = water;
    waterChart.update();

    rainChart.data.labels = labels;
    rainChart.data.datasets[0].data = rain;
    rainChart.update();

    // Update current values
    const last = records[records.length - 1];
    waterLevelEl.innerText = last.water + "%";
    rainValueEl.innerText = last.rain + "%";
    timeEl.innerText = last.time;

    if (last.water > 80) alarm.play();

    // Update forecast immediately
    updateForecast(records);
});

/* -------------------------------------------------------------
   AUTO-UPDATE FORECAST EVERY 60 SEC
------------------------------------------------------------- */
setInterval(() => {
    if (latestRecords.length > 0) {
        updateForecast(latestRecords);
    }
}, 60000);

</script>

</body>
</html>
