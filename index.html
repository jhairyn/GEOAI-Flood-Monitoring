<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Flood Monitoring Dashboard</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0; padding: 0;
    }
    h1 { text-align:center; padding:20px; margin:0; background:#2196F3; color:white; }

    .container { width:95%; margin:20px auto; }

    .cards {
      display:flex; gap:20px; margin-bottom:20px;
    }
    .card {
      flex:1; background:white; padding:20px;
      border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .card h3 { margin:0 0 10px 0; }

    #chartContainer {
      background:white; padding:20px; border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
      margin-bottom:20px;
    }

    table {
      width:100%; border-collapse:collapse; background:white;
      border-radius:10px; overflow:hidden;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    th, td {
      padding:8px 10px; border-bottom:1px solid #ddd; text-align:center;
    }
    th { background:#2196F3; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }

    #predictedRisk { font-weight:bold; }
  </style>
</head>

<body>

<h1>Flood Monitoring Dashboard</h1>

<div class="container">

  <!-- Data Cards -->
  <div class="cards">
    <div class="card">
      <h3>Predicted Water Level (10 min)</h3>
      <p id="predictedHeight" style="font-size:24px;">--</p>
    </div>

    <div class="card">
      <h3>Predicted Rain</h3>
      <p id="predictedRain" style="font-size:24px;">--</p>
    </div>

    <div class="card">
      <h3>Flood Risk</h3>
      <p id="predictedRisk" style="font-size:24px;">--</p>
    </div>
  </div>

  <!-- Graph -->
  <div id="chartContainer">
    <canvas id="waterChart"></canvas>
  </div>

  <!-- Table -->
  <h2>All Records</h2>
  <table id="recordsTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Water %</th>
        <th>Water Height (m)</th>
        <th>Distance (m)</th>
        <th>Rain Intensity</th>
        <th>Rain Class</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Alarm -->
  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

</div>

<script>
  // ============================
  //   FIREBASE CONFIG
  // ============================
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB",
    projectId: "YOUR_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_MSG",
    appId: "YOUR_APP"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();


  // ============================
  //   CHART SETUP
  // ============================
  const ctx = document.getElementById("waterChart").getContext("2d");
  const waterChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        {
          label: "Water Level (%)",
          data: [],
          borderColor: "blue",
          fill: false
        },
        {
          label: "Forecast",
          data: [],
          borderColor: "red",
          borderDash: [5,5],
          fill: false
        }
      ]
    }
  });

  let lastRecords = [];

  // ============================
  //   PREDICTION ENGINE
  // ============================
  function computeLinearTrendPrediction(recordsArr, minutesAhead=10){
    if(recordsArr.length < 3) return null;
    const t0 = recordsArr[0].timestamp;
    const xs = recordsArr.map(r => (r.timestamp - t0) / 60);
    const ys = recordsArr.map(r => r.water_percentage);
    const n = xs.length;

    let sumX=0,sumY=0,sumXY=0,sumXX=0;
    for(let i=0;i<n;i++){
      sumX += xs[i];
      sumY += ys[i];
      sumXY += xs[i]*ys[i];
      sumXX += xs[i]*xs[i];
    }
    const denom = n*sumXX - sumX*sumX;
    if(denom===0) return null;

    const slope = (n*sumXY - sumX*sumY) / denom;
    const intercept = (sumY - slope*sumX) / n;

    const lastX = xs[xs.length-1];
    const futureX = lastX + minutesAhead;

    let predicted = slope * futureX + intercept;

    const avgRain = recordsArr.reduce((a,b)=>a+(b.rain_intensity||0),0) / recordsArr.length;
    const rainFactor = avgRain < 20 ? 0.02 : avgRain < 50 ? 0.05 : 0.10;

    predicted *= (1 + rainFactor);
    predicted = Math.max(0, Math.min(100, predicted));

    let rainLabel = avgRain >= 50 ? "Heavy Rain" :
                    avgRain >= 20 ? "Moderate Rain" : "Light / None";

    let risk = predicted >= 80 ? "HIGH" :
               predicted >= 50 ? "MEDIUM" : "LOW";

    return {
      predictedValue: predicted,
      avgRain: avgRain,
      predictedRainLabel: rainLabel,
      risk: risk
    };
  }

  // ============================
  //   UPDATE FORECAST
  // ============================
  function updateForecast(){
    if(lastRecords.length===0) return;

    const pred = computeLinearTrendPrediction(lastRecords, 10);
    const ph = document.getElementById("predictedHeight");
    const pr = document.getElementById("predictedRain");
    const pk = document.getElementById("predictedRisk");
    const alarm = document.getElementById("alarmSound");

    if(!pred){
      ph.innerText="--";
      pr.innerText="--";
      pk.innerText="Unknown";
      return;
    }

    ph.innerText = pred.predictedValue.toFixed(1)+"%";
    pr.innerText = pred.predictedRainLabel + " (avg " + pred.avgRain.toFixed(1) + ")";
    pk.innerText = pred.risk;
    pk.style.color = pred.risk==="HIGH" ? "red" : pred.risk==="MEDIUM" ? "orange" : "green";

    if(pred.predictedValue >= 80){
      if(alarm.paused) alarm.play();
    } else {
      alarm.pause(); alarm.currentTime=0;
    }

    const labels = lastRecords.map(r =>
      new Date(r.timestamp*1000).toLocaleTimeString()
    );
    const main = lastRecords.map(r => r.water_percentage);

    labels.push("Forecast");
    main.push(null);

    const forecastArr = new Array(lastRecords.length).fill(null);
    forecastArr.push(pred.predictedValue);

    waterChart.data.labels = labels;
    waterChart.data.datasets[0].data = main;
    waterChart.data.datasets[1].data = forecastArr;
    waterChart.update();
  }

  // Auto-run forecast every minute
  setInterval(updateForecast, 60000);

  // ============================
  //   FETCH FIREBASE DATA
  // ============================
  db.ref("flood-data/records").on("value", snap => {
    const tableBody = document.querySelector("#recordsTable tbody");
    tableBody.innerHTML = "";

    let all = [];
    snap.forEach(child=>{
      const v = child.val();
      all.push({
        timestamp: Number(v.timestamp),
        water_percentage: Number(v.water_percentage),
        water_height_m: Number(v.water_height_m),
        distance_m: Number(v.distance_m),
        rain_intensity: Number(v.rain_intensity),
        rain_class: v.rain_class || ""
      });

      // Insert row in table
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(v.timestamp*1000).toLocaleString()}</td>
        <td>${v.water_percentage}</td>
        <td>${v.water_height_m}</td>
        <td>${v.distance_m}</td>
        <td>${v.rain_intensity}</td>
        <td>${v.rain_class}</td>
      `;
      tableBody.appendChild(tr);
    });

    all.sort((a,b)=>a.timestamp - b.timestamp);
    lastRecords = all.slice(-20);   // Graph uses last 20 only

    updateForecast(); // instant update
  });
</script>

</body>
</html>
